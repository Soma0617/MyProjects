@model IEnumerable<FinalExamProject.Models.Product>
@{
    ViewData["Title"] = "商品列表";
    var q = ViewBag.Q as string;
    int? categoryId = ViewBag.CategoryId as int?;
    int page = (int)(ViewBag.Page ?? 1);
    int pageSize = (int)(ViewBag.PageSize ?? 12);
    int total = (int)(ViewBag.Total ?? 0);
    int totalPages = (int)(ViewBag.TotalPages ?? 0);
    var categories = ViewBag.Categories as List<FinalExamProject.Models.Category>;
}

<div class="container py-4">
    <h2 class="mb-4">商品列表</h2>

    <!-- 搜尋與篩選 -->
    <form method="get" class="row g-2 mb-4">
        <div class="col-md-5">
            <input name="q" value="@q" class="form-control" placeholder="輸入關鍵字（名稱、代碼、描述）">
        </div>
        <div class="col-md-3">
            <select name="categoryId" class="form-select">
                <option value="">全部分類</option>
                @foreach (var c in categories!)
                {
                    <option value="@c.CategoryID" selected="@(categoryId == c.CategoryID)">
                        @c.CategoryName
                    </option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <select name="pageSize" class="form-select">
                @{
                    int[] sizes = new[] { 6, 12, 24, 36, 48 };
                }
                @foreach (var s in sizes)
                {
                    <option value="@s" selected="@(pageSize == s)">@s / 頁</option>
                }
            </select>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary" type="submit">查詢</button>
        </div>
    </form>

    <!-- 商品卡片 -->
    @if (!Model.Any())
    {
        <div class="alert alert-info">沒有符合條件的商品。</div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-3">
            @foreach (var p in Model)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <img class="card-img-top"
                             src="@(string.IsNullOrWhiteSpace(p.Photo) ? Url.Content("~/images/no-image.png") : p.Photo)"
                             alt="@p.ProductName"
                             style="object-fit:cover;height:180px;">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title text-truncate" title="@p.ProductName">@p.ProductName</h6>
                            <div class="mb-2 text-muted small">@p.CategoryInfo?.CategoryName</div>
                            <div class="fw-bold mb-3">@p.Price.ToString("C")</div>
                            <div class="mt-auto d-grid gap-2">
                                <a asp-area="Store" asp-controller="Catalog" asp-action="Details" asp-route-id="@p.ProductID"
                                   class="btn btn-outline-primary btn-sm">查看詳細</a>
                                <form asp-area="Store" asp-controller="Cart" asp-action="Add" method="post" class="d-inline">
                                    <input type="hidden" name="id" value="@p.ProductID" />
                                    <input type="hidden" name="qty" value="1" />
                                    <button type="submit" class="btn btn-sm btn-primary">加入購物車</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- 分頁器 -->
        @if (totalPages > 1)
        {
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    @{
                        int window = 2;
                        int start = Math.Max(1, page - window);
                        int end = Math.Min(totalPages, page + window);

                        Func<int, string> pageUrl = p =>
                        Url.Action("Index", new { q = q, categoryId = categoryId, page = p, pageSize = pageSize })!;
                    }
                    <li class="page-item @(page == 1 ? "disabled" : "")">
                        <a class="page-link" href="@pageUrl(page - 1)">«</a>
                    </li>
                    @for (var i = start; i <= end; i++)
                    {
                        <li class="page-item @(i == page ? "active" : "")">
                            <a class="page-link" href="@pageUrl(i)">@i</a>
                        </li>
                    }
                    <li class="page-item @(page == totalPages ? "disabled" : "")">
                        <a class="page-link" href="@pageUrl(page + 1)">»</a>
                    </li>
                </ul>
                <div class="text-center text-muted small">共 @total 筆，@totalPages 頁</div>
            </nav>
        }
    }
</div>
