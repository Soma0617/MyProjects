@model FinalExamProject.Models.ShoppingCar
@{
    ViewData["Title"] = "購物車";
}

<div class="container py-4">
    <h2 class="mb-4">🛒 我的購物車</h2>

    @if (!Model.Items.Any())
    {
        <div class="alert alert-info">購物車目前是空的。</div>
    }
    else
    {
        <!-- 外層表單：用來「更新數量」；同時也提供 Anti-Forgery Token -->
        <form id="cartForm" asp-action="Update" method="post">
            @Html.AntiForgeryToken()

            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>商品</th>
                        <th>單價</th>
                        <th style="width:120px;">數量</th>
                        <th>小計</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        var item = Model.Items[i];
                        <tr>
                            <td>
                                <img src="@(string.IsNullOrWhiteSpace(item.Photo) ? Url.Content("~/images/no-image.png") : item.Photo)"
                                     style="width:60px;height:60px;object-fit:cover" class="me-2" />
                                @item.ProductName
                                <input type="hidden" name="ids[@i]" value="@item.ProductID" />
                            </td>
                            <td>@item.UnitPrice.ToString("C")</td>
                            <td>
                                <input type="number" name="quantities[@i]" value="@item.Quantity" min="1" class="form-control form-control-sm" />
                            </td>
                            <td>@((item.UnitPrice * item.Quantity).ToString("C"))</td>
                            <td>
                                <!-- 不要再用巢狀 form；改用 formaction 指向 Remove（POST），共用本 form 的 Anti-Forgery Token -->
                                <button type="submit"
                                        class="btn btn-sm btn-danger"
                                        formmethod="post"
                                        formaction="@Url.Action("Remove", "Cart", new { area = "Store" })"
                                        name="id"
                                        value="@item.ProductID">
                                    移除
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center">
                <button type="submit" class="btn btn-outline-secondary">更新數量</button>

                <div class="ms-auto text-end">
                    <div class="fw-bold fs-5">
                        總金額：@Model.Items.Sum(i => i.UnitPrice * i.Quantity).ToString("C")
                    </div>
                </div>
            </div>
        </form>

        <!-- 清空購物車：獨立 form，避免巢狀 -->
        <div class="mt-3 d-flex justify-content-between">
            <a asp-area="Store" asp-controller="Catalog" asp-action="Index" class="btn btn-outline-primary">繼續購物</a>

            <form asp-action="Clear" method="post" class="m-0">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-danger">清空購物車</button>
            </form>
        </div>
    }
</div>
