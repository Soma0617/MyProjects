@model IEnumerable<FinalExamProject.Models.Account>
@using FinalExamProject.Models
@{
    ViewData["Title"] = "帳號列表";

    var query = ViewBag.Query as AccountQueryVm ?? new AccountQueryVm();
    int total = ViewBag.Total ?? 0;
    int curPage = ViewBag.Page ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int totalPages = (int)Math.Ceiling((double)Math.Max(0, total) / Math.Max(1, pageSize));

    string SortLink(string key) => Url.Action("Index", new
    {
        q = query.Q,
        sort = key,
        page = curPage,
        pageSize
    });

    string PageLink(int p) => Url.Action("Index", new
    {
        q = query.Q,
        sort = query.Sort,
        page = p,
        pageSize
    });
}

<div class="container py-4">

    <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="mb-0">帳號列表</h2>
        <a asp-action="Create" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> 新增帳號
        </a>
    </div>

    @* 訊息 *@
    @if (TempData["ok"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["ok"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* 查詢列 *@
    <form method="get" class="card mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">關鍵字（帳號 / 會員 Email）</label>
                    <input type="text" name="q" class="form-control" value="@query.Q" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">每頁筆數</label>
                    <select name="pageSize" class="form-select">
                        @{
                            var sizes = new[] { 5, 10, 20, 50 };
                            foreach (var s in sizes)
                            {
                                <option value="@s" selected="@(pageSize == s)">@s /頁</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3 text-end">
                    <button class="btn btn-primary"><i class="bi bi-search"></i> 查詢</button>
                    <a asp-action="Index" class="btn btn-outline-secondary">重設</a>
                </div>
            </div>
        </div>
    </form>

    <div class="d-flex justify-content-between align-items-center text-muted mb-2">
        <small>共 @total 筆，頁次 @(curPage) / @(Math.Max(1, totalPages))</small>
        <div>
            <div class="btn-group btn-group-sm" role="group" aria-label="sort">
                <a class="btn btn-outline-secondary @(query.Sort == "account" ? "active" : "")" href="@SortLink("account")">帳號 ↑</a>
                <a class="btn btn-outline-secondary @(query.Sort == "account_desc" ? "active" : "")" href="@SortLink("account_desc")">帳號 ↓</a>
            </div>
        </div>
    </div>

    @* 資料表 *@
    <div class="table-responsive rounded shadow-sm">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th style="width: 240px;">帳號</th>
                    <th>會員</th>
                    <th style="width: 220px;" class="text-end">操作</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr><td colspan="3" class="text-center text-muted py-4">沒有資料</td></tr>
                }
                else
                {
                    foreach (var a in Model)
                    {
                        <tr>
                            <td class="fw-semibold">@a.AccountID</td>
                            <td>
                                @if (a.MemberInfo is not null)
                                {
                                    <div class="d-flex flex-column">
                                        <span>@a.MemberInfo.Name</span>
                                        <small class="text-muted">@a.MemberInfo.Email</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">未連結會員</span>
                                }
                            </td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <a asp-action="Details" asp-route-id="@a.AccountID" class="btn btn-outline-secondary">詳細</a>
                                    <a asp-action="Edit" asp-route-id="@a.AccountID" class="btn btn-primary">編輯</a>
                                    <a asp-action="Delete" asp-route-id="@a.AccountID" class="btn btn-danger">刪除</a>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @* 分頁 *@
    <nav class="mt-3">
        <ul class="pagination mb-0">
            <li class="page-item @(curPage <= 1 ? "disabled" : null)">
                <a class="page-link" href="@PageLink(curPage - 1)">«</a>
            </li>
            @for (int i = 1; i <= Math.Max(1, totalPages); i++)
            {
                <li class="page-item @(i == curPage ? "active" : null)">
                    <a class="page-link" href="@PageLink(i)">@i</a>
                </li>
            }
            <li class="page-item @(curPage >= totalPages ? "disabled" : null)">
                <a class="page-link" href="@PageLink(curPage + 1)">»</a>
            </li>
        </ul>
    </nav>
</div>
